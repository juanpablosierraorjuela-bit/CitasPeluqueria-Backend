{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reserva | {{ peluqueria.nombre_visible }}</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #1e293b; --accent: #db2777; --bg: #f8fafc; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: var(--primary); margin: 0; padding-bottom: 80px; }
        .header { background: white; padding: 20px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .card.selected { border-color: var(--accent); background: #fdf2f8; }
        .input-fancy { width: 100%; padding: 15px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 1rem; margin-bottom: 15px; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; cursor: pointer; position: fixed; bottom: 0; left: 0; border-radius: 0; z-index: 100; }
        .btn-main:disabled { background: #cbd5e1; }
        .hidden { display: none; }
        
        .pay-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .pay-option { border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; cursor: pointer; background: white; }
        .pay-option.selected { border-color: var(--accent); background: #fdf2f8; color: var(--accent); font-weight: bold; }
        .pay-option i { font-size: 1.5rem; }

        /* Opciones de Cobro */
        .cobro-options { display: flex; gap: 10px; margin-top: 15px; display: none; }
        .cobro-option { flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.9rem; }
        .cobro-option.active { background: var(--accent); color: white; border-color: var(--accent); }

        .price-summary { margin-top: 20px; padding: 15px; background: #fff1f2; border-radius: 12px; text-align: center; }
        .total-price { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .error-msg { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; font-size: 1.8rem;">{{ peluqueria.nombre_visible }}</h1>
        <p style="margin:5px 0; color: #64748b;">
            {% if peluqueria.esta_abierto %}
                <span style="color: green;">● Abierto ahora</span>
            {% else %}
                <span style="color: red;">● Cerrado ahora</span>
            {% endif %}
        </p>
    </div>

    <div class="container">
        {% if error_mensaje %}
            <div class="error-msg">{{ error_mensaje }}</div>
        {% endif %}

        <form method="POST" id="bookingForm">
            {% csrf_token %}
            <input type="hidden" name="fecha_seleccionada" id="input_fecha">
            <input type="hidden" name="hora_seleccionada" id="input_hora">
            <input type="hidden" name="empleado" id="input_empleado">
            
            <input type="hidden" name="metodo_pago" id="input_metodo_pago" value="">
            <input type="hidden" name="tipo_cobro" id="input_tipo_cobro" value="TOTAL">

            <h3>1. Elige Servicio</h3>
            {% for s in servicios %}
            <div class="card" onclick="toggleService(this, {{ s.precio }})">
                <input type="checkbox" name="servicios" value="{{ s.id }}" class="hidden check-servicio">
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>{{ s.nombre }}</span>
                    <span>${{ s.precio }}</span>
                </div>
                <small style="color:#64748b;">{{ s.str_duracion }}</small>
            </div>
            {% endfor %}

            <div id="step-empleado" class="hidden">
                <h3>2. Elige Profesional</h3>
                <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                    {% for e in empleados %}
                    <div class="card" style="min-width:100px; text-align:center;" onclick="selectStylist(this, '{{ e.id }}')">
                        <div style="width:50px; height:50px; background:#e2e8f0; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                            {{ e.nombre|first }}
                        </div>
                        <span>{{ e.nombre }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div id="step-fecha" class="hidden">
                <h3>3. Fecha y Hora</h3>
                <input type="date" id="picker-fecha" class="input-fancy" required>
                <div id="loading" class="hidden" style="text-align:center; color:#64748b;">Buscando disponibilidad...</div>
                <div id="contenedor-horas" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;"></div>
            </div>

            <div id="step-datos" class="hidden">
                <h3>4. Tus Datos</h3>
                <input type="text" name="nombre_cliente" class="input-fancy" placeholder="Tu Nombre" required>
                <input type="tel" name="telefono_cliente" class="input-fancy" placeholder="WhatsApp (10 dígitos)" pattern="[0-9]{10}" required>

                <h3>Forma de Pago</h3>
                <div class="pay-grid">
                    {% if tiene_bold %}
                    <div class="pay-option" id="opt-bold" onclick="setPago(this, 'BOLD')">
                        <i class="fas fa-credit-card" style="color:#db2777;"></i>
                        <div>
                            <strong>Pago Seguro (Tarjetas/PSE)</strong><br>
                            <small>Bold</small>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if tiene_nequi %}
                    <div class="pay-option" id="opt-nequi" onclick="setPago(this, 'NEQUI')">
                        <i class="fas fa-mobile-alt"></i> Nequi
                    </div>
                    {% endif %}
                    
                    {% if not solo_pago_digital %}
                    <div class="pay-option selected" id="opt-sitio" onclick="setPago(this, 'SITIO')">
                        <i class="fas fa-store"></i> Pagar en el Salón
                    </div>
                    {% endif %}
                </div>

                <div id="opciones-cobro" class="cobro-options">
                    <div class="cobro-option active" onclick="setTipoCobro('TOTAL', this)">
                        Pagar Total<br>
                        <strong id="label-total">$0</strong>
                    </div>
                    {% if peluqueria.porcentaje_abono < 100 %}
                    <div class="cobro-option" onclick="setTipoCobro('ABONO', this)">
                        Abonar {{ peluqueria.porcentaje_abono }}%<br>
                        <strong id="label-abono">$0</strong>
                    </div>
                    {% endif %}
                </div>

                <div class="price-summary">
                    Total a pagar ahora: <div class="total-price" id="final-price">$0</div>
                </div>

                <p style="font-size:0.8rem; color:#64748b; margin-top:10px; text-align: center;">
                    * Al reservar aceptas nuestras políticas de cancelación.
                </p>
            </div>

            <button type="submit" class="btn-main" id="btn-submit" disabled>CONFIRMAR RESERVA</button>
        </form>
    </div>

    <script>
        const pickerFecha = document.getElementById('picker-fecha');
        pickerFecha.min = new Date().toISOString().split('T')[0];
        let totalServicios = 0;
        const porcentajeAbono = {{ peluqueria.porcentaje_abono }};

        // Autoselección de método de pago al cargar
        document.addEventListener("DOMContentLoaded", function() {
            const sitio = document.getElementById('opt-sitio');
            const bold = document.getElementById('opt-bold');
            const nequi = document.getElementById('opt-nequi');
            
            // Si la opción de sitio no existe (porque es pago digital obligatorio)
            if (!sitio) {
                if (bold) {
                    setPago(bold, 'BOLD');
                } else if (nequi) {
                    setPago(nequi, 'NEQUI');
                }
            } else {
                // Si existe sitio, es el default
                setPago(sitio, 'SITIO'); 
            }
        });

        function toggleService(card, precio) {
            const chk = card.querySelector('input');
            chk.checked = !chk.checked;
            card.classList.toggle('selected', chk.checked);
            if(chk.checked) totalServicios += precio; else totalServicios -= precio;
            updatePrices(); checkVisibility();
        }

        function updatePrices() {
            const abono = Math.round(totalServicios * (porcentajeAbono / 100));
            document.getElementById('label-total').innerText = '$' + totalServicios.toLocaleString();
            const labelAbono = document.getElementById('label-abono');
            if(labelAbono) labelAbono.innerText = '$' + abono.toLocaleString();
            const tipo = document.getElementById('input_tipo_cobro').value;
            const final = (tipo === 'TOTAL') ? totalServicios : abono;
            document.getElementById('final-price').innerText = '$' + final.toLocaleString();
        }

        function selectStylist(card, id) {
            document.querySelectorAll('#step-empleado .card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('input_empleado').value = id;
            document.getElementById('step-fecha').classList.remove('hidden');
            pickerFecha.scrollIntoView({behavior:'smooth'});
        }

        pickerFecha.addEventListener('change', async () => {
            const fecha = pickerFecha.value;
            const emp = document.getElementById('input_empleado').value;
            const servs = Array.from(document.querySelectorAll('.check-servicio:checked')).map(c => c.value);
            document.getElementById('input_fecha').value = fecha;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('contenedor-horas').innerHTML = '';
            
            // Fetch a la API con la fecha seleccionada
            const res = await fetch(`/api/horarios/?empleado_id=${emp}&fecha=${fecha}&s=${servs.join(',')}`);
            const data = await res.json();
            
            document.getElementById('loading').classList.add('hidden');
            const cont = document.getElementById('contenedor-horas');
            
            if(data.horas.length === 0) {
                cont.innerHTML = '<div style="grid-column:1/-1; text-align:center;">No hay cupos disponibles.</div>'; return;
            }
            data.horas.forEach(h => {
                const btn = document.createElement('div');
                btn.className = 'card';
                btn.style.textAlign = 'center';
                btn.style.marginBottom = '0';
                btn.textContent = h;
                btn.onclick = () => {
                    document.querySelectorAll('#contenedor-horas div').forEach(d => d.classList.remove('selected'));
                    btn.classList.add('selected');
                    document.getElementById('input_hora').value = h;
                    document.getElementById('step-datos').classList.remove('hidden');
                    document.getElementById('btn-submit').disabled = false;
                    setTimeout(() => document.getElementById('step-datos').scrollIntoView({behavior:'smooth'}), 100);
                };
                cont.appendChild(btn);
            });
        });

        function setPago(elem, metodo) {
            document.querySelectorAll('.pay-option').forEach(e => e.classList.remove('selected'));
            elem.classList.add('selected');
            document.getElementById('input_metodo_pago').value = metodo;
            const divOpciones = document.getElementById('opciones-cobro');
            if (metodo === 'BOLD') {
                divOpciones.style.display = 'flex'; 
                // Seleccionar Total por defecto al cambiar a Bold
                const optTotal = divOpciones.querySelector('.cobro-option');
                if(optTotal) setTipoCobro('TOTAL', optTotal);
            } else {
                divOpciones.style.display = 'none'; 
                setTipoCobro('TOTAL', null);
            }
            updatePrices();
        }

        function setTipoCobro(tipo, elem) {
            document.getElementById('input_tipo_cobro').value = tipo;
            if(elem) {
                document.querySelectorAll('.cobro-option').forEach(e => e.classList.remove('active'));
                elem.classList.add('active');
            }
            updatePrices();
        }

        function checkVisibility() {
            if(document.querySelectorAll('.check-servicio:checked').length > 0) document.getElementById('step-empleado').classList.remove('hidden');
            else document.getElementById('step-empleado').classList.add('hidden');
        }
    </script>
</body>
</html>
