{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva en {{ peluqueria.nombre_visible }}</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ec4899">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-dark: #0f172a;
            --accent-color: #ec4899;
            --card-bg: #ffffff;
            --border-light: #e2e8f0;
            --primary-gradient: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            --accent-gradient: linear-gradient(90deg, #ec4899 0%, #8b5cf6 100%);
        }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: var(--text-dark); }
        .container { background: var(--card-bg); padding: 40px; border-radius: 24px; width: 100%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 40px; position: relative; z-index: 10; }
        
        .error-alert { background-color: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }

        .step-label { font-weight: 700; margin: 20px 0 10px; display: flex; gap: 10px; align-items: center; }
        .step-number { background: #f1f5f9; width: 25px; height: 25px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; }
        
        /* --- ESTILOS: LISTA CON CHULITOS --- */
        .lista-servicios {
            display: flex; flex-direction: column; border: 1px solid var(--border-light); border-radius: 12px; overflow: hidden;
        }
        .servicio-row {
            display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; background: white;
        }
        .servicio-row:last-child { border-bottom: none; }
        .servicio-row:hover { background-color: #f8fafc; }
        .hidden-check { display: none; }
        .custom-checkbox {
            width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 6px; margin-right: 15px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s; background: white; flex-shrink: 0;
        }
        .check-svg { width: 14px; height: 14px; stroke: white; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; opacity: 0; transition: transform 0.2s, opacity 0.2s; transform: scale(0.5); }
        .hidden-check:checked + .custom-checkbox { background-color: var(--accent-color); border-color: var(--accent-color); }
        .hidden-check:checked + .custom-checkbox .check-svg { opacity: 1; transform: scale(1); }
        .servicio-data { flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .servicio-info-main { display: flex; flex-direction: column; }
        .nombre { font-weight: 500; color: var(--text-dark); font-size: 1rem; }
        .badge { font-size: 0.75rem; color: #64748b; margin-top: 4px; display: inline-flex; align-items: center; gap: 4px; }
        .precio { font-weight: 700; color: var(--text-dark); font-size: 1rem; }

        select, input[type="text"], input[type="tel"], input[type="date"] { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-light); margin-bottom: 10px; font-family: inherit; }
        #contenedor-horas { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
        .btn-hora { padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; text-align: center; cursor: pointer; background: white; }
        .btn-hora:hover { background: #f1f5f9; }
        .btn-hora.seleccionado { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        
        #btn-confirmar { width: 100%; padding: 15px; background: var(--accent-gradient); color: white; border: none; border-radius: 50px; font-weight: 600; margin-top: 20px; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        #btn-confirmar.activo { opacity: 1; pointer-events: all; }

        .hidden { display: none; }
        .pago-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .pago-label { flex: 1; border: 1px solid var(--border-light); padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; font-size: 0.9rem; }
        .pago-input { display: none; }
        .pago-input:checked + .pago-label { background: #fdf2f8; border-color: var(--accent-color); color: var(--accent-color); font-weight: 600; }

        /* --- BOT√ìN JOYA --- */
        .admin-jewel-btn {
            position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px; border-radius: 50%;
            background: #0f172a; border: 2px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center; text-decoration: none; z-index: 1000;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .admin-jewel-btn .icon { font-size: 1.6rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); transition: transform 0.4s ease; }
        .admin-jewel-btn:hover { background: var(--accent-gradient); transform: scale(1.1) rotate(-10deg); border-color: transparent; box-shadow: 0 0 25px rgba(236, 72, 153, 0.6); }
        .admin-jewel-btn:hover .icon { transform: scale(1.2); }
        
        .site-footer { margin-top: auto; padding: 20px; text-align: center; font-size: 0.8rem; color: #94a3b8; }
        .owner-link { color: #cbd5e1; text-decoration: none; transition: color 0.3s; margin-left: 10px; border: 1px solid #e2e8f0; padding: 5px 12px; border-radius: 20px; }
        .owner-link:hover { color: #ec4899; border-color: #ec4899; background: white; }
    </style>
</head>
<body>

    {% if request.user.is_authenticated and request.user.is_staff %}
        <a href="{% url 'admin:index' %}" class="admin-jewel-btn" title="Gestionar mi Sal√≥n">
            <span class="icon">üëë</span> </a>
    {% endif %}

<div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Agenda tu Cita</h1>
        <p style="color: #64748b;">{{ peluqueria.nombre_visible }}</p>
    </div>

    {% if error_mensaje %}
        <div class="error-alert">{{ error_mensaje }}</div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="fecha_seleccionada" id="input_fecha">
        <input type="hidden" name="hora_seleccionada" id="input_hora">

        <div class="step-label"><span class="step-number">1</span> Servicios</div>
        
        <div class="lista-servicios">
            {% for s in servicios %}
            <label class="servicio-row">
                <input type="checkbox" name="servicios" value="{{ s.id }}" class="hidden-check check-servicio">
                <div class="custom-checkbox">
                    <svg class="check-svg" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>
                </div>
                <div class="servicio-data">
                    <div class="servicio-info-main">
                        <span class="nombre">{{ s.nombre }}</span>
                        <span class="badge">‚è±Ô∏è {{ s.str_duracion }}</span>
                    </div>
                    <span class="precio">${{ s.precio }}</span>
                </div>
            </label>
            {% endfor %}
        </div>

        <div id="step-empleado" class="hidden">
            <div class="step-label"><span class="step-number">2</span> Estilista</div>
            <select name="empleado" id="empleado">
                <option value="" disabled selected>Selecciona...</option>
                {% for e in empleados %}
                    <option value="{{ e.id }}">{{ e.nombre }} {{ e.apellido }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="step-fecha" class="hidden">
            <div class="step-label"><span class="step-number">3</span> Fecha y Hora</div>
            <input type="date" id="picker-fecha">
            <div id="contenedor-horas"></div>
        </div>

        <div id="step-datos" class="hidden">
            <div class="step-label"><span class="step-number">4</span> Tus Datos</div>
            <input type="text" name="nombre_cliente" id="input_nombre" placeholder="Nombre completo" required>
            <input type="tel" name="telefono_cliente" id="input_telefono" placeholder="Celular" required>

            {% if peluqueria.bold_api_key %}
                <div style="margin-top: 15px;">
                    <label style="font-size: 0.9rem; color: #64748b; display:block; margin-bottom:8px;">¬øC√≥mo deseas pagar?</label>
                    <div class="pago-options">
                        <label>
                            <input type="radio" name="tipo_pago" value="completo" class="pago-input" checked>
                            <div class="pago-label">Pago Total (100%)</div>
                        </label>
                        <label>
                            <input type="radio" name="tipo_pago" value="abono" class="pago-input">
                            <div class="pago-label">Abonar el {{ peluqueria.porcentaje_abono }}%</div>
                        </label>
                    </div>
                </div>
            {% endif %}

            <div style="background: #fff1f2; border: 1px solid #fda4af; padding: 15px; border-radius: 12px; margin: 20px 0; font-size: 0.85rem; color: #9f1239;">
                <strong style="display:block; margin-bottom: 5px;">‚ö†Ô∏è Pol√≠tica de Cancelaci√≥n:</strong>
                <ul style="padding-left: 20px; margin: 0; line-height: 1.4;">
                    <li>Si no asistes, el dinero no ser√° reembolsado.</li>
                    <li>Reprograma avisando con 4 horas de anticipaci√≥n.</li>
                </ul>
            </div>

            <div style="display: flex; gap: 10px; align-items: start; margin-bottom: 10px; font-size: 0.9rem;">
                <input type="checkbox" id="check_terminos" style="width: 20px; height: 20px; display: block; margin-top: 2px; cursor: pointer;" required>
                <label for="check_terminos" style="cursor: pointer; color: #475569;">
                    He le√≠do y acepto las pol√≠ticas.
                </label>
            </div>
        </div>

        <button type="submit" id="btn-confirmar" disabled>Confirmar Reserva</button>
    </form>
</div>

<div class="site-footer">
    <span>Tecnolog√≠a PASO &copy; 2025</span>
    {% if not request.user.is_authenticated %}
        <a href="{% url 'admin:index' %}" class="owner-link">Soy el Due√±o</a>
    {% endif %}
</div>

<script>
    // --- NUEVO: REGISTRAR EL SERVICE WORKER PARA QUE SEA INSTALABLE ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('/static/js/sw.js').then(function(registration) {
                console.log('SW registrado');
            }, function(err) {
                console.log('SW fall√≥: ', err);
            });
        });
    }
    // ------------------------------------------------------------------

    const checks = document.querySelectorAll('.check-servicio');
    const selEmpleado = document.getElementById('empleado');
    const pickerFecha = document.getElementById('picker-fecha');
    const divHoras = document.getElementById('contenedor-horas');
    
    const btnConfirmar = document.getElementById('btn-confirmar');
    const inputNombre = document.getElementById('input_nombre');
    const inputTelefono = document.getElementById('input_telefono');
    const checkTerminos = document.getElementById('check_terminos');
    const inputHora = document.getElementById('input_hora');

    pickerFecha.min = new Date().toISOString().split('T')[0];

    checks.forEach(c => c.addEventListener('change', () => {
        const hay = Array.from(checks).some(x => x.checked);
        document.getElementById('step-empleado').classList.toggle('hidden', !hay);
        if(!hay) reset(2);
    }));

    selEmpleado.addEventListener('change', () => {
        document.getElementById('step-fecha').classList.remove('hidden');
        pickerFecha.value = '';
        divHoras.innerHTML = '';
        reset(3);
    });

    pickerFecha.addEventListener('change', async () => {
        const fecha = pickerFecha.value;
        const empId = selEmpleado.value;
        const sIds = Array.from(document.querySelectorAll('.check-servicio:checked')).map(x => x.value);
        
        if(!fecha || !empId || sIds.length===0) return;

        document.getElementById('input_fecha').value = fecha;
        divHoras.innerHTML = '<p style="color:gray; font-size:0.9rem;">Buscando...</p>';

        try {
            const res = await fetch(`/api/horarios/?empleado_id=${empId}&fecha=${fecha}&servicios_ids=${sIds.join(',')}`);
            const data = await res.json();
            divHoras.innerHTML = '';
            
            if(data.horas && data.horas.length > 0) {
                data.horas.forEach(h => {
                    const btn = document.createElement('div');
                    btn.className = 'btn-hora';
                    btn.textContent = h;
                    btn.onclick = () => selectHora(btn, h);
                    divHoras.appendChild(btn);
                });
            } else {
                divHoras.innerHTML = '<p style="color:orange;">No hay cupos disponibles.</p>';
            }
        } catch(e) { console.error(e); }
    });

    function selectHora(elem, hora) {
        document.querySelectorAll('.btn-hora').forEach(b => b.classList.remove('seleccionado'));
        elem.classList.add('seleccionado');
        inputHora.value = hora;
        document.getElementById('step-datos').classList.remove('hidden');
        validarFormulario();
        document.getElementById('step-datos').scrollIntoView({behavior: "smooth"});
    }

    function validarFormulario() {
        if (inputHora.value && inputNombre.value.trim() && inputTelefono.value.trim() && checkTerminos.checked) {
            btnConfirmar.disabled = false;
            btnConfirmar.classList.add('activo');
        } else {
            btnConfirmar.disabled = true;
            btnConfirmar.classList.remove('activo');
        }
    }

    inputNombre.addEventListener('input', validarFormulario);
    inputTelefono.addEventListener('input', validarFormulario);
    checkTerminos.addEventListener('change', validarFormulario);

    function reset(nivel) {
        if(nivel <= 2) { selEmpleado.value=""; document.getElementById('step-fecha').classList.add('hidden'); }
        if(nivel <= 3) { document.getElementById('step-datos').classList.add('hidden'); inputHora.value = ""; btnConfirmar.disabled=true; btnConfirmar.classList.remove('activo'); }
    }
</script>
</body>
</html>
