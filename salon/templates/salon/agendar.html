{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva en {{ peluqueria.nombre_visible }}</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ec4899">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-dark: #0f172a;
            --accent-color: #ec4899;
            --card-bg: #ffffff;
            --border-light: #e2e8f0;
            --primary-gradient: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            --accent-gradient: linear-gradient(90deg, #ec4899 0%, #8b5cf6 100%);
        }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-color); display: flex; justify-content: center; padding: 20px; color: var(--text-dark); }
        .container { background: var(--card-bg); padding: 40px; border-radius: 24px; width: 100%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .error-alert { background-color: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }

        .step-label { font-weight: 700; margin: 20px 0 10px; display: flex; gap: 10px; align-items: center; }
        .step-number { background: #f1f5f9; width: 25px; height: 25px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; }
        
        .servicio-card { padding: 15px; border: 1px solid var(--border-light); border-radius: 12px; display: flex; justify-content: space-between; margin-bottom: 10px; cursor: pointer; transition: 0.2s; align-items: center; }
        .servicio-option input:checked + .servicio-card { border-color: var(--accent-color); background: #fdf2f8; }
        
        /* NUEVO ESTILO PARA DURACIÓN */
        .badge-duracion {
            font-size: 0.75rem; color: #64748b; background: #e2e8f0; 
            padding: 3px 8px; border-radius: 10px; margin-left: 8px; font-weight: 500;
        }

        select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-light); margin-bottom: 10px; font-family: inherit; }
        #contenedor-horas { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
        .btn-hora { padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; text-align: center; cursor: pointer; background: white; }
        .btn-hora:hover { background: #f1f5f9; }
        .btn-hora.seleccionado { background: var(--text-dark); color: white; border-color: var(--text-dark); }
        #btn-confirmar { width: 100%; padding: 15px; background: var(--accent-gradient); color: white; border: none; border-radius: 50px; font-weight: 600; margin-top: 30px; cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        #btn-confirmar:not(:disabled) { opacity: 1; pointer-events: all; }
        .hidden { display: none; }
        input[type="checkbox"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Agenda tu Cita</h1>
        <p style="color: #64748b;">{{ peluqueria.nombre_visible }}</p>
    </div>

    {% if error_mensaje %}
        <div class="error-alert">{{ error_mensaje }}</div>
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="fecha_seleccionada" id="input_fecha">
        <input type="hidden" name="hora_seleccionada" id="input_hora">

        <div class="step-label"><span class="step-number">1</span> Servicios</div>
        {% for s in servicios %}
            <label class="servicio-option">
                <input type="checkbox" name="servicios" value="{{ s.id }}" class="check-servicio">
                <div class="servicio-card">
                    <div>
                        <span>{{ s.nombre }}</span>
                        <!-- AQUÍ MOSTRAMOS LA DURACIÓN -->
                        <span class="badge-duracion">⏱️ {{ s.str_duracion }}</span>
                    </div>
                    <strong>${{ s.precio }}</strong>
                </div>
            </label>
        {% endfor %}

        <div id="step-empleado" class="hidden">
            <div class="step-label"><span class="step-number">2</span> Estilista</div>
            <select name="empleado" id="empleado">
                <option value="" disabled selected>Selecciona...</option>
                {% for e in empleados %}
                    <option value="{{ e.id }}">{{ e.nombre }} {{ e.apellido }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="step-fecha" class="hidden">
            <div class="step-label"><span class="step-number">3</span> Fecha y Hora</div>
            <input type="date" id="picker-fecha">
            <div id="contenedor-horas"></div>
        </div>

        <div id="step-datos" class="hidden">
            <div class="step-label"><span class="step-number">4</span> Tus Datos</div>
            <input type="text" name="nombre_cliente" placeholder="Nombre completo" required>
            <input type="tel" name="telefono_cliente" placeholder="Celular" required>
        </div>

        <button type="submit" id="btn-confirmar" disabled>Confirmar Reserva</button>
    </form>
</div>

<script>
    const checks = document.querySelectorAll('.check-servicio');
    const selEmpleado = document.getElementById('empleado');
    const pickerFecha = document.getElementById('picker-fecha');
    const divHoras = document.getElementById('contenedor-horas');
    const btnConfirmar = document.getElementById('btn-confirmar');
    
    pickerFecha.min = new Date().toISOString().split('T')[0];

    checks.forEach(c => c.addEventListener('change', () => {
        const hay = Array.from(checks).some(x => x.checked);
        document.getElementById('step-empleado').classList.toggle('hidden', !hay);
        if(!hay) reset(2);
    }));

    selEmpleado.addEventListener('change', () => {
        document.getElementById('step-fecha').classList.remove('hidden');
        pickerFecha.value = '';
        divHoras.innerHTML = '';
        reset(3);
    });

    pickerFecha.addEventListener('change', async () => {
        const fecha = pickerFecha.value;
        const empId = selEmpleado.value;
        const sIds = Array.from(document.querySelectorAll('.check-servicio:checked')).map(x => x.value);
        
        if(!fecha || !empId || sIds.length===0) return;

        document.getElementById('input_fecha').value = fecha;
        divHoras.innerHTML = '<p style="color:gray; font-size:0.9rem;">Buscando...</p>';

        try {
            const res = await fetch(`/api/horarios/?empleado_id=${empId}&fecha=${fecha}&servicios_ids=${sIds.join(',')}`);
            const data = await res.json();
            divHoras.innerHTML = '';
            
            if(data.horas && data.horas.length > 0) {
                data.horas.forEach(h => {
                    const btn = document.createElement('div');
                    btn.className = 'btn-hora';
                    btn.textContent = h;
                    btn.onclick = () => selectHora(btn, h);
                    divHoras.appendChild(btn);
                });
            } else {
                divHoras.innerHTML = '<p style="color:orange;">No hay cupos disponibles.</p>';
            }
        } catch(e) { console.error(e); }
    });

    function selectHora(elem, hora) {
        document.querySelectorAll('.btn-hora').forEach(b => b.classList.remove('seleccionado'));
        elem.classList.add('seleccionado');
        document.getElementById('input_hora').value = hora;
        document.getElementById('step-datos').classList.remove('hidden');
        btnConfirmar.disabled = false;
        btnConfirmar.scrollIntoView({behavior: "smooth"});
    }

    function reset(nivel) {
        if(nivel <= 2) { selEmpleado.value=""; document.getElementById('step-fecha').classList.add('hidden'); }
        if(nivel <= 3) { document.getElementById('step-datos').classList.add('hidden'); btnConfirmar.disabled=true; }
    }
</script>
</body>
</html>
