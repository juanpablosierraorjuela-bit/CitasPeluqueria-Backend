<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar en {{ peluqueria.nombre_visible }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #dfa6b0; --dark: #c58692; --bg: #fdfbfb; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 100%; max-width: 500px; }
        h1 { font-family: 'Playfair Display'; text-align: center; color: #333; }
        
        /* Checkboxes bonitos para servicios */
        .servicio-option { display: block; margin-bottom: 10px; cursor: pointer; }
        .servicio-card { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border: 1px solid #eee; border-radius: 10px; transition: all 0.2s;
        }
        .servicio-option input:checked + .servicio-card { 
            border-color: var(--primary); background: #fff0f3; color: #333;
        }
        input[type="checkbox"] { display: none; } /* Ocultar el checkbox feo */

        /* Botones de hora */
        #contenedor-horas { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .btn-hora { padding: 10px; border: 1px solid #eee; border-radius: 8px; text-align: center; cursor: pointer; }
        .btn-hora.seleccionado { background: var(--primary); color: white; border-color: var(--primary); }
        
        button[type="submit"] { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 30px; font-weight: 600; margin-top: 30px; cursor: pointer; }
        button:disabled { background: #eee; cursor: not-allowed; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Reserva tu Cita</h1>
    <h3 style="text-align:center; color:#888; font-weight:300;">{{ peluqueria.nombre_visible }}</h3>

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="fecha_seleccionada" id="input_fecha">
        <input type="hidden" name="hora_seleccionada" id="input_hora">

        <label><strong>1. Selecciona los tratamientos:</strong></label>
        <div style="margin-top: 10px;">
            {% for s in servicios %}
                <label class="servicio-option">
                    <input type="checkbox" name="servicios" value="{{ s.id }}" class="check-servicio">
                    <div class="servicio-card">
                        <span>{{ s.nombre }}</span>
                        <span style="font-weight:600;">${{ s.precio }}</span>
                    </div>
                </label>
            {% endfor %}
        </div>

        <div id="step-empleado" class="hidden" style="margin-top:20px;">
            <label><strong>2. Elige profesional:</strong></label>
            <select name="empleado" id="empleado" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ddd;">
                <option value="" disabled selected>-- Seleccionar --</option>
                {% for e in empleados %}
                    <option value="{{ e.id }}">{{ e.nombre }} {{ e.apellido }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="step-fecha" class="hidden" style="margin-top:20px;">
            <label><strong>3. Selecciona fecha:</strong></label>
            <input type="date" id="picker-fecha" style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #ddd;">
            
            <div id="contenedor-horas"></div>
            <p id="mensaje-error" style="color:red; text-align:center;"></p>
        </div>

        <div id="step-datos" class="hidden" style="margin-top:20px;">
            <label><strong>4. Tus datos:</strong></label>
            <input type="text" name="nombre_cliente" placeholder="Nombre completo" required style="width:92%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
            <input type="tel" name="telefono_cliente" placeholder="TelÃ©fono" required style="width:92%; padding:10px; border-radius:8px; border:1px solid #ddd;">
        </div>

        <button type="submit" id="btn-confirmar" disabled>CONFIRMAR CITA</button>
    </form>
</div>

<script>
    const checksServicios = document.querySelectorAll('.check-servicio');
    const stepEmpleado = document.getElementById('step-empleado');
    const empleadoSelect = document.getElementById('empleado');
    const stepFecha = document.getElementById('step-fecha');
    const fechaInput = document.getElementById('picker-fecha');
    const contenedorHoras = document.getElementById('contenedor-horas');
    const stepDatos = document.getElementById('step-datos');
    const btnConfirmar = document.getElementById('btn-confirmar');

    // Al seleccionar servicios, mostramos empleado
    checksServicios.forEach(check => {
        check.addEventListener('change', () => {
            const haySeleccion = Array.from(checksServicios).some(c => c.checked);
            if(haySeleccion) stepEmpleado.classList.remove('hidden');
            else {
                stepEmpleado.classList.add('hidden');
                resetPasosDesde(2);
            }
            resetPasosDesde(3); // Si cambia servicios, debe reelegir hora
        });
    });

    empleadoSelect.addEventListener('change', () => {
        stepFecha.classList.remove('hidden');
        fechaInput.value = '';
        contenedorHoras.innerHTML = '';
    });

    fechaInput.addEventListener('change', async () => {
        const fecha = fechaInput.value;
        const empleadoId = empleadoSelect.value;
        
        // Obtener IDs de servicios seleccionados (Array)
        const serviciosIds = Array.from(document.querySelectorAll('.check-servicio:checked')).map(c => c.value);

        if (!fecha || !empleadoId || serviciosIds.length === 0) return;

        document.getElementById('input_fecha').value = fecha;
        contenedorHoras.innerHTML = 'Cargando...';

        try {
            // Enviamos la lista de IDs unida por comas
            const response = await fetch(`/api/horarios/?empleado_id=${empleadoId}&fecha=${fecha}&servicios_ids=${serviciosIds.join(',')}`);
            const data = await response.json();
            
            contenedorHoras.innerHTML = '';
            if (data.horas && data.horas.length > 0) {
                data.horas.forEach(hora => {
                    const btn = document.createElement('div');
                    btn.className = 'btn-hora';
                    btn.textContent = hora;
                    btn.onclick = () => seleccionarHora(btn, hora);
                    contenedorHoras.appendChild(btn);
                });
            } else {
                contenedorHoras.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Sin horas disponibles.</p>';
            }
        } catch (e) { console.error(e); }
    });

    function seleccionarHora(btn, hora) {
        document.querySelectorAll('.btn-hora').forEach(b => b.classList.remove('seleccionado'));
        btn.classList.add('seleccionado');
        document.getElementById('input_hora').value = hora;
        stepDatos.classList.remove('hidden');
        btnConfirmar.disabled = false;
        btnConfirmar.scrollIntoView({behavior: "smooth"});
    }

    function resetPasosDesde(paso) {
        if(paso <= 2) { empleadoSelect.value = ""; stepFecha.classList.add('hidden'); }
        if(paso <= 3) { fechaInput.value = ""; contenedorHoras.innerHTML = ""; stepDatos.classList.add('hidden'); btnConfirmar.disabled = true; }
    }
    
    fechaInput.setAttribute('min', new Date().toISOString().split('T')[0]);
</script>
</body>
</html>