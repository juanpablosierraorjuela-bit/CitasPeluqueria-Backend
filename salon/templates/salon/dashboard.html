{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | PASO</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0f172a; --secondary: #475569; --accent: #db2777; --bg: #f8fafc; --surface: #ffffff;
            --success: #10b981; --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: var(--primary); margin: 0; padding-bottom: 40px; }
        
        /* HEADER */
        .dashboard-header { background: var(--surface); padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .brand { font-weight: 800; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .user-menu { display: flex; gap: 15px; align-items: center; }
        .btn-logout { font-size: 0.9rem; color: #ef4444; text-decoration: none; font-weight: 600; padding: 8px 15px; background: #fef2f2; border-radius: 8px; }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        
        /* ALERTS */
        .alert-box { padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: 600; display: flex; gap: 10px; align-items: center; }
        .alert-warning { background: #fff7ed; color: #c2410c; border: 1px solid #fdba74; }
        
        /* STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--accent); }
        .stat-label { color: var(--secondary); font-size: 0.9rem; font-weight: 600; }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 10px; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; border: none; background: none; font-weight: 600; color: var(--secondary); cursor: pointer; border-radius: 8px; transition: 0.2s; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        /* CARDS & FORMS */
        .card { background: var(--surface); border-radius: 16px; padding: 30px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 30px; }
        .card h2 { margin-top: 0; font-size: 1.3rem; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 700; font-size: 0.9rem; margin-bottom: 8px; color: var(--secondary); }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.95rem; }
        input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.1); }
        
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-save:hover { background: #1e293b; }

        /* PAYMENT CONFIG */
        .pay-config-grid { display: grid; gap: 30px; grid-template-columns: 1fr; }
        @media(min-width: 768px) { .pay-config-grid { grid-template-columns: 1fr 1fr; } }
        
        .pay-box { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .pay-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .pay-logo { height: 30px; }
        
        .tooltip { font-size: 0.8rem; color: #64748b; margin-top: 5px; line-height: 1.4; }
        .badge-configured { background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .menu-item { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; text-decoration: none; color: var(--primary); transition: 0.2s; font-weight: 700; text-align: center; gap: 10px; box-shadow: var(--shadow); }
        .menu-item:hover { border-color: var(--accent); transform: translateY(-3px); }
        .menu-icon { font-size: 1.8rem; color: var(--accent); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="brand">
            <i class="fas fa-cut" style="color:var(--accent);"></i>
            <span>PASO Manager</span>
        </div>
        <div class="user-menu">
            <span style="font-weight:600; display:none; @media(min-width:600px){display:block;}">{{ peluqueria.nombre_visible }}</span>
            <a href="{% url 'logout_usuario' %}" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Salir</a>
        </div>
    </header>

    <div class="container">
        
        {% if alerta_pago %}
        <div class="alert-box alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>{{ alerta_pago }} <a href="{% url 'pago_suscripcion_saas' %}" style="color:inherit; text-decoration:underline;">Pagar Ahora</a></span>
        </div>
        {% endif %}

        {% if messages %}
            {% for message in messages %}
            <div class="alert-box" style="background:#dcfce7; color:#166534; border:1px solid #86efac;">
                <i class="fas fa-check-circle"></i> {{ message }}
            </div>
            {% endfor %}
        {% endif %}

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val">{{ citas_hoy }}</div>
                <div class="stat-label">Citas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">{{ empleados.count }}</div>
                <div class="stat-label">Equipo Activo</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" style="font-size:1.2rem; color:var(--primary);">{{ proximo_pago|date:"d M" }}</div>
                <div class="stat-label">Pr贸ximo Corte</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab(event, 'tab-inicio')"> Men煤 Principal</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-config')">锔 Configuraci贸n</button>
            <button class="tab-btn" onclick="openTab(event, 'tab-pagos')"> M茅todos de Pago</button>
        </div>

        <div id="tab-inicio" class="tab-content active">
            <div class="menu-grid">
                <a href="{% url 'gestionar_servicios' %}" class="menu-item">
                    <i class="fas fa-list menu-icon"></i>
                    <span>Mis Servicios</span>
                </a>
                <a href="{% url 'gestionar_equipo' %}" class="menu-item">
                    <i class="fas fa-users menu-icon"></i>
                    <span>Mi Equipo</span>
                </a>
                <a href="{% url 'mi_agenda' %}" class="menu-item">
                    <i class="fas fa-calendar-alt menu-icon"></i>
                    <span>Mi Agenda</span>
                </a>
                <a href="{% url 'pago_suscripcion_saas' %}" class="menu-item">
                    <i class="fas fa-receipt menu-icon"></i>
                    <span>Mi Suscripci贸n</span>
                </a>
            </div>

            <div class="card" style="margin-top:30px; padding:20px; background:#eff6ff; border-color:#bfdbfe;">
                <h3 style="margin-top:0; font-size:1rem; color:#1e3a8a;"><i class="fas fa-link"></i> Link para Empleados</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" value="{{ link_invitacion }}" id="linkInput" readonly style="background:white;">
                    <button onclick="copiarLink()" class="btn-save" style="width:auto; background:#2563eb;">Copiar</button>
                </div>
                <p class="tooltip">Env铆a este link a tus estilistas para que se registren y configuren sus horarios.</p>
            </div>
        </div>

        <div id="tab-config" class="tab-content">
            <div class="card">
                <h2>Datos del Negocio</h2>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="accion" value="guardar_info">
                    
                    <div class="form-group">
                        <label>Direcci贸n F铆sica</label>
                        <input type="text" name="direccion" value="{{ peluqueria.direccion }}" placeholder="Ej: Cra 10 # 20-30">
                    </div>
                    
                    <div class="form-group">
                        <label>Tel茅fono / WhatsApp</label>
                        <input type="text" name="telefono" value="{{ peluqueria.telefono }}" placeholder="Ej: 3001234567">
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="form-group">
                            <label>Abre</label>
                            <input type="time" name="hora_apertura" value="{{ peluqueria.hora_apertura|time:'H:i' }}">
                        </div>
                        <div class="form-group">
                            <label>Cierra</label>
                            <input type="time" name="hora_cierre" value="{{ peluqueria.hora_cierre|time:'H:i' }}">
                        </div>
                    </div>

                    <h3 style="margin-top:20px; font-size:1rem;">Notificaciones (Opcional)</h3>
                    <div class="form-group">
                        <label>Token Telegram Bot</label>
                        <input type="password" name="telegram_token" value="{{ peluqueria.telegram_token|default:'' }}" placeholder="Solo si quieres alertas">
                    </div>
                    <div class="form-group">
                        <label>Chat ID Telegram</label>
                        <input type="text" name="telegram_chat_id" value="{{ peluqueria.telegram_chat_id|default:'' }}">
                    </div>

                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </form>
            </div>
        </div>

        <div id="tab-pagos" class="tab-content">
            <div class="card">
                <h2>Configuraci贸n de Cobros</h2>
                <p style="margin-bottom:20px; color:var(--secondary);">Configura c贸mo quieres recibir el dinero de tus clientes.</p>
                
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="accion" value="guardar_pagos">
                    
                    <div class="form-group">
                        <label>Porcentaje de Anticipo (%)</label>
                        <input type="number" name="porcentaje_abono" value="{{ peluqueria.porcentaje_abono }}" min="0" max="100">
                        <p class="tooltip">Cu谩nto deben pagar tus clientes online para confirmar la cita.</p>
                    </div>

                    <div class="pay-config-grid">
                        <div class="pay-box">
                            <div class="pay-header">
                                <span style="font-weight:800; font-size:1.2rem;">BOLD</span>
                                {% if peluqueria.bold_api_key %}
                                <span class="badge-configured">Activo</span>
                                {% endif %}
                            </div>
                            <p class="tooltip" style="margin-bottom:15px;">
                                Para cobros autom谩ticos con tarjeta. Ve a tu <a href="https://merchants.bold.co/" target="_blank">Panel de Bold</a> > Desarrolladores.
                            </p>
                            
                            <div class="form-group">
                                <label>Llave de Identidad (API Key)</label>
                                <input type="password" name="bold_api_key" value="{{ peluqueria.bold_api_key|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label>Llave de Integridad</label>
                                <input type="password" name="bold_integrity_key" value="{{ peluqueria.bold_integrity_key|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label>Llave Secreta</label>
                                <input type="password" name="bold_secret_key" value="{{ peluqueria.bold_secret_key|default:'' }}">
                            </div>
                        </div>

                        <div class="pay-box">
                            <div class="pay-header">
                                <span style="font-weight:800; font-size:1.2rem;">NEQUI</span>
                                {% if peluqueria.nequi_celular %}
                                <span class="badge-configured">Activo</span>
                                {% endif %}
                            </div>
                            <p class="tooltip" style="margin-bottom:15px;">
                                Para transferencias manuales. El cliente ver谩 tu n煤mero y QR.
                            </p>

                            <div class="form-group">
                                <label>Celular Nequi</label>
                                <input type="text" name="nequi_celular" value="{{ peluqueria.nequi_celular|default:'' }}" placeholder="Ej: 3001234567">
                            </div>

                            <div class="form-group">
                                <label>Imagen QR (Opcional)</label>
                                {% if peluqueria.nequi_qr_imagen %}
                                    <div style="margin-bottom:10px;">
                                        <img src="{{ peluqueria.nequi_qr_imagen.url }}" style="max-width:100px; border-radius:8px;">
                                        <br>
                                        <label style="font-weight:400; font-size:0.8rem;">
                                            <input type="checkbox" name="borrar_qr" value="si" style="width:auto;"> Borrar imagen actual
                                        </label>
                                    </div>
                                {% endif %}
                                <input type="file" name="nequi_qr_imagen" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-save" style="margin-top:20px;">Guardar Configuraci贸n de Pagos</button>
                </form>
            </div>
        </div>

    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        function copiarLink() {
            var copyText = document.getElementById("linkInput");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("Link copiado!");
        }
    </script>
</body>
</html>
